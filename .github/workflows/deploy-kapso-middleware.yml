name: Deploy Kapso Middleware to Cloud Run

on:
    push:
        branches: [ main ]
        paths:
        - "services/kapso_middleware/**"
        - ".github/workflows/deploy-kapso-middleware.yml"

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
        - uses: actions/checkout@v4

        - name: Authenticate to Google Cloud
          uses: google-github-actions/auth@v2
          with:
            credentials_json: ${{ secrets.GCP_SA_KEY }}

        - name: Setup Google Cloud CLI
          uses: google-github-actions/setup-gcloud@v2
          with:
            project_id: ${{ secrets.GCP_PROJECT_ID }}

        - name: Deploy kapso-middleware service
          working-directory: services/kapso_middleware
          env:
            PARSER_URL: ${{ secrets.PARSER_URL }}
            PARSER_API_KEY: ${{ secrets.PARSER_API_KEY }}
            KAPSO_API_KEY: ${{ secrets.KAPSO_API_KEY }}
            KAPSO_WEBHOOK_SECRET: ${{ secrets.KAPSO_WEBHOOK_SECRET }}
            AGENT_ONBOARDING_URL: ${{ secrets.AGENT_ONBOARDING_URL }}
            AGENT_CAMPAIGN_URL: ${{ secrets.AGENT_CAMPAIGN_URL }}
            AGENT_FEEDBACK_URL: ${{ secrets.AGENT_FEEDBACK_URL }}
            AGENT_SETTER_URL: ${{ secrets.AGENT_SETTER_URL }}
          run: |
            gcloud run deploy kapso-middleware \
              --source . \
              --platform managed \
              --region us-east1 \
              --allow-unauthenticated \
              --quiet \
              --set-build-env-vars=GOOGLE_BUILD_NO_CACHE=true \
              --set-env-vars="PARSER_URL=${PARSER_URL},\
PARSER_API_KEY=${PARSER_API_KEY},\
LOG_BODIES=false,\
KAPSO_BASE_URL=https://app.kapso.ai/api/meta/,\
KAPSO_WHATSAPP_BASE_URL=https://api.kapso.ai/meta/whatsapp/,\
KAPSO_API_KEY=${KAPSO_API_KEY},\
KAPSO_WEBHOOK_SECRET=${KAPSO_WEBHOOK_SECRET},\
AGENT_ONBOARDING_URL=${AGENT_ONBOARDING_URL},\
AGENT_CAMPAIGN_URL=${AGENT_CAMPAIGN_URL},\
AGENT_FEEDBACK_URL=${AGENT_FEEDBACK_URL},\
AGENT_SETTER_URL=${AGENT_SETTER_URL},\
FORWARD_TO_PARSER=false"
